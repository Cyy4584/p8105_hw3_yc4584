---
title: "p8105_hw3_yc4584"
author: "Yingyu Cui"
date: "2024-10-08"
output: github_document
---

```{r setup and figure preferrences}
library(tidyverse)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1
```{r load data}
library(p8105.datasets)
data("ny_noaa")
```


```{r NA data check}
na_counts = colSums(is.na(ny_noaa))

print(na_counts)
```

- A short discription:
There are 2595176 rows and 7 columns in this data frame. The data frame contains the information of the weather in New York from January 1, 1981 through December 31, 2010. The key variables are "date", "temperature_min", "temperature_max", "precipitation", "snowfall", "snow_depth". In all of the variables, the "prcp", "snow" and "snwd" variables are numeric variables and the "tmax", "tmin" and "id" are recognized as character variables. However, I would prefer to transfer "tman" and "tmin" into numeric characters. The missing data in every column is shown in the following table. 
     id    date    prcp    snow    snwd    tmax    tmin 
      0       0  145838  381221  591786 1134358 1134420 
We can see that there are around half of the data missing in the "tmax" and "tmin" columns. In "prcp", "snow" and "snwd" columns, there are less data missing, but still a large amount of data missing.

Question 1:
- Create separate variables for year, month, and day
```{r create variables}
ny_noaa = ny_noaa |> 
  mutate(year = year(date),
         month = month(date),
         day = day(date))
```

- Ensure observations for temperature, precipitation, and snowfall are given in reasonable units
we want the units for "prcp", "snow" and "snwd" to be tenths of mm, and the units for "tmax" and "tmin" to be in Celsius.  
```{r change units}
ny_noaa = ny_noaa |>
  mutate(tmax = as.numeric(tmax)) |>
  mutate(tmin = as.numeric(tmin)) |>
  mutate(
    prcp = ifelse(is.na(prcp), NA, prcp * 1/10),
    snow = ifelse(is.na(snow), NA, snow * 1/10),
    snwd = ifelse(is.na(snwd), NA, snwd * 1/10),
    tmax = ifelse(is.na(tmax), NA, (tmax - 32) * 5/9),
    tmin = ifelse(is.na(tmin), NA, (tmin - 32) * 5/9)
  )
```

-  most commonly observed values for snowfall
```{r most commonly observed values for snowfall}
common_snowfall = ny_noaa |> 
  count(snow) |> 
  arrange(desc(n))

print(common_snowfall)
```
We could find out that the most commonly observed value for snowfall is 0.0, which is 381221 times. I think this is because that snowfall is not a daily occurrence in most regions. Many places experience long periods without any snowfall, especially during non-winter months. Even in regions where snow is common, there are often days when no snow falls. 


Question2:
- Make a two-panel plot showing the average max temperature in January and in July in each station across years.
```{r two-panel plot showing the average max temperature}
ny_noaa_filtered_plot = ny_noaa |> 
  filter(month %in% c(1, 7)) |> 
  group_by(id, year, month) |> 
  summarize(avg_tmax = mean(tmax, na.rm = TRUE)) |> 
  ggplot(aes(x = year, y = avg_tmax)) +
  geom_point() +
  facet_grid(. ~ month) +
  labs(
    title = "Average Maximum Temperature in January and July",
    x = "Year",
    y = "Average Max Temperature (°C)"
  ) 
print(ny_noaa_filtered_plot)
```

- A short discription:Is there any observable / interpretable structure? Any outliers?
From the plot, we could see that the average maximum temperature in January is lower than that in July. The average maximum temperature in July is more stable than that In January. There are some outliers in the plot, but they are not very significant. The outliers in the January plot are approximately equally distributed in the lower and higher parts of the plot. The outliers in the July plot are mainly distributed in the lower part of the plot.


Question3:
- Part (i): tmax vs tmin plot using hexbin plot
```{r tmax vs tmin plot}
p1 = ggplot(ny_noaa, aes(x = tmin, y = tmax)) +
  geom_hex() +
  labs(
    title = "tmax vs tmin",
    x = "Minimum Temperature (°C)",
    y = "Maximum Temperature (°C)",
    fill = "Count"
  ) 
print(p1)
```
  Part (ii): Distribution of snowfall values > 0 and < 100, separated by year
```{r Distribution of snowfall values}
p2 = ny_noaa |> 
  filter(snow > 0 & snow < 100) |> 
  ggplot(aes(x = snow)) +
  geom_histogram(fill = "skyblue", color = "black") +
  facet_grid(. ~ year) +
  labs(
    title = "Distribution of Snowfall (0 < snowfall < 100)",
    x = "Snowfall (tenths of mm)",
    y = "Count"
  )
print(p2)
```

Combination of p1 and p2
```{r Combination of p1 and p2}
library(gridExtra)
grid.arrange(p1, p2, nrow = 1) 
```


# Problem 2
Load data
```{r load data2}
demographic_df = read_csv("./data/nhanes_covar.csv", skip = 4)
accelerometer_df = read_csv("./data/nhanes_accel.csv")
```
tidy the data 
```{r tidy the data for demographic_df}
demographic_df = demographic_df |> 
  janitor::clean_names() |>
  drop_na() |> 
  filter(age >= 21) |> 
  mutate(sex = as.character(sex)) |> 
  mutate(
    sex = case_when(
      sex == "1" ~ "male",
      sex == "2" ~ "female")) |>
  mutate(education = as.character(education)) |> 
  mutate(
    education = case_when(
      education == "1" ~ "less than high school",
      education == "2" ~ "high school equivalent",
      education == "3" ~ "more than high school")) |> 
  mutate(
    education = factor(
      education, 
      levels = c("less than high school", "high school equivalent", "more than high school")))
```

```{r tidy the data for accelerometer_df}
accelerometer_df = accelerometer_df |> 
  janitor::clean_names()
```
merge the data sets
```{r merge the data sets}
merge_df = left_join(demographic_df, accelerometer_df, by = "seqn")
print(merge_df)
```


men and women in each education category
```{r men and women in each education}
gender_education_df = merge_df |> 
  group_by(sex, education) |>
  summarize(count = n()) |> 
  pivot_wider(names_from = education, values_from = count)
print(gender_education_df)
```

age distribution for men and women in different education
```{r age distribution}
hist_distribution = merge_df |>
  ggplot(aes(x = age, fill = sex)) +
  geom_histogram(alpha = 0.5, position = "identity") +
  facet_wrap(~ education) +
  labs(
    title = "Age Distribution by Gender in Each Education Category",
    x = "Age",
    y = "Count",
    fill = "Gender"
  ) 
print(hist_distribution)
```
We could see from this histogram and the table that in this study the people from the "more than high school" education category are the most, and the number of people from the "less than high school" and "high school equivalent" education category are similar. In the "high school equivalent" education level, the number of women are more than men, but in the other two education levels, the number of men and women are similar. The age distribution in the "more than high school" education category is more concentrated in the younger age, and the age distribution in the "less than high school" education category is more concentrated in the older age. The age distribution in the "high school equivalent" education category is concentrated in the extreme young and extreme old age, the distribution in the middle age is pretty much even.

plot total activity against age
```{r total activity calculation and add to merge_df}
start_col = which(names(merge_df) == "min1")
end_col = which(names(merge_df) == "min1440")
numeric_cols_to_sum = names(merge_df)[start_col:end_col]
merge_df$total_activity = rowSums(merge_df[numeric_cols_to_sum])
print(merge_df)
```

```{r plot scatterplot}
scatterplot_total_activity = merge_df |>
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE) + 
  facet_wrap(~ education) +  
  labs(title = "Total Activities by Age, Gender, and Education Level",
       x = "Age",
       y = "Total Activity",
       color = "Gender") 
print(scatterplot_total_activity)
```
comment: 
From the plot, we could see that the general trends of total activity in all types of population are decreasing with age. However, with age growing, the total activity of people with "less than high school" education level is decreasing faster than the other two education levels. The total activity of people with "more than high school" education level is decreasing slower than the other two education levels. Specifically, there is a peak of total activity in the population with "less than high school" education level at the age of around 60. For the people with "high school equivalent" education level, the increase or peak is at the age of around 40. For the people with "more than high school" education level, the trend is more stable and the peak for women is at the age of around 50, for man is at the age of around 60. For sex, in both "high school equivalent" and "more than high school", the total activity in women is lower than men at the same age. However, in the "less than high school" education level, the women older than 40 have higher total activity than men at the same age. 


24 hours activity time course
```{r 24 hours activity time course}
time_course = merge_df |>
  select(seqn, sex, education, starts_with("min")) |>
  pivot_longer(cols = starts_with("min"), names_to = "minute", values_to = "activity") |>
  mutate(minute = as.numeric(str_remove(minute, "min"))) 
```

```{r plot 24 hours activity time course}
time_course_plot = 
  ggplot(time_course, aes(x = minute, y = activity, color = sex)) +
  geom_line(alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed") +
  facet_wrap(~ education) +
  labs(title = "24-Hour Activity Time Courses by Education Level",
       x = "Minute of the Day",
       y = "Activity Time",
       color = "Gender")
print(time_course_plot)
```

comment:
We could see from the plot that the highest activity time in a day for different educational level is different, but the lowest activity time for them all are around 4:00-5:00. For the people with "less than high school" education level, the highest activity time is around 10:00-11:00, and the activity time is decreasing after that. For the people with "high school equivalent" education level, the highest activity time is around 8:00-9:00, and the activity time is decreasing after that with a small peak at around 19:00-20:00 for women in this educational type. For the people with "more than high school" education level, the highest activity time is around 8:00-9:00 for men and 20:00-21:00 for women, and the activity time is relatively low between these. In general, the activity time of people with "more than high school" education level is higher than the other two education levels. Although there are difference in the activity time between gender and educational level, the general trend in three panels are similar. The activity time is increasing to peak of the day at 12:00-13:00 and decreasing. Also, the difference between gender is not very significant. Maybe, the women with "less than high school" education level has slightly more activity time than men in this educational level, but the difference is not very significant. In the other two panels, activity time for men is slightly higher than women.

